# CAHIER DES SPÃ‰CIFICATIONS FONCTIONNELLES DÃ‰TAILLÃ‰ES
## PLATEFORME DE GESTION SELF-STORAGE & VALET STORAGE

---

## TABLE DES MATIÃˆRES

1. [PRÃ‰SENTATION GÃ‰NÃ‰RALE](#1-prÃ©sentation-gÃ©nÃ©rale)
2. [ARCHITECTURE TECHNIQUE](#2-architecture-technique)
3. [MODULES BACKEND](#3-modules-backend)
4. [MODULES FRONTEND](#4-modules-frontend)
5. [SYSTÃˆME DE RÃ‰SERVATION EN LIGNE](#5-systÃ¨me-de-rÃ©servation-en-ligne)
6. [MODULE VALET STORAGE](#6-module-valet-storage)
7. [GESTION FINANCIÃˆRE & FACTURATION](#7-gestion-financiÃ¨re--facturation)
8. [SYSTÃˆME D'ANALYTICS & REPORTING](#8-systÃ¨me-danalytics--reporting)
9. [INTÃ‰GRATIONS](#9-intÃ©grations)
10. [SÃ‰CURITÃ‰ & CONFORMITÃ‰](#10-sÃ©curitÃ©--conformitÃ©)
11. [API & WEBHOOKS](#11-api--webhooks)
12. [ARCHITECTURE BASE DE DONNÃ‰ES](#12-architecture-base-de-donnÃ©es)
13. [SPÃ‰CIFICATIONS TECHNIQUES DÃ‰TAILLÃ‰ES](#13-spÃ©cifications-techniques-dÃ©taillÃ©es)

---

## 1. PRÃ‰SENTATION GÃ‰NÃ‰RALE

### 1.1 Vue d'ensemble du projet

**Nom du projet:** StoragePro Platform  
**Type:** Plateforme SaaS multi-tenant de gestion de self-storage et valet storage  
**Objectif:** Automatiser et digitaliser complÃ¨tement les opÃ©rations des entreprises de self-storage et valet storage

### 1.2 ProblÃ©matiques adressÃ©es

- Automatisation des rÃ©servations et paiements
- Gestion multi-sites centralisÃ©e
- RÃ©duction des tÃ¢ches administratives rÃ©pÃ©titives
- AmÃ©lioration de l'expÃ©rience client avec rÃ©servations contactless
- Gestion logistique pour services valet storage
- ContrÃ´le d'accÃ¨s automatisÃ©
- Analytics et reporting en temps rÃ©el
- ConformitÃ© RGPD et sÃ©curitÃ© des donnÃ©es

### 1.3 Utilisateurs cibles

1. **OpÃ©rateurs mono-site:** PME avec une seule installation
2. **OpÃ©rateurs multi-sites:** Entreprises avec plusieurs installations (2-100+ sites)
3. **Entreprises valet storage:** Services de stockage avec livraison/rÃ©cupÃ©ration
4. **Entreprises hybrides:** Mix self-storage + valet storage

### 1.4 ModÃ¨les d'affaires supportÃ©s

- Self-storage traditionnel
- Valet storage (stockage avec service de livraison)
- Wine storage (caves Ã  vin)
- Mobile storage
- Climate-controlled storage
- ModÃ¨les hybrides

---

## 2. ARCHITECTURE TECHNIQUE

### 2.1 Stack technologique recommandÃ©e

#### Backend
```
- Framework: Laravel 11.x (PHP 8.3+)
- Base de donnÃ©es: PostgreSQL 15+ (principal) + Redis (cache/sessions)
- API: RESTful API + GraphQL (optionnel pour queries complexes)
- Queue System: Laravel Horizon + Redis
- Real-time: Laravel Echo + Pusher/Socket.io
- Scheduler: Laravel Task Scheduling
- Storage: AWS S3 / DigitalOcean Spaces
```

#### Frontend
```
- Portal Admin: Vue.js 3 + Inertia.js OU React 18+ avec Vite
- Portal Client: Vue.js 3 / React 18 (PWA)
- UI Framework: Tailwind CSS 3.x
- State Management: Pinia (Vue) / Zustand (React)
- Charts: Chart.js / Recharts
- Maps: Google Maps API / Mapbox
```

#### Infrastructure
```
- Cloud: AWS / DigitalOcean / Azure
- CI/CD: GitHub Actions / GitLab CI
- Monitoring: Sentry + New Relic / DataDog
- CDN: CloudFlare
- Email: SendGrid / Amazon SES
- SMS: Twilio
- Backup: AutomatisÃ© quotidien avec rÃ©tention 30 jours
```

### 2.2 Architecture multi-tenant

#### Approche par domaine

```
Structure:
- tenant1.storageplatform.com (Client 1)
- tenant2.storageplatform.com (Client 2)
- app.storageplatform.com (Admin principal)
```

#### Isolation des donnÃ©es

```php
// ModÃ¨le de donnÃ©es
- tenant_id sur toutes les tables principales
- Scopes globaux Laravel pour isolation automatique
- Middleware de dÃ©tection tenant
- Configuration tenant-specific (branding, features, pricing)
```

### 2.3 Architecture de la base de donnÃ©es

```
Architecture:
- Base principale partagÃ©e (tenants config, system tables)
- Tables avec tenant_id pour isolation logique
- Partitionnement pour grandes installations
- RÃ©plication master-slave pour lecture intensive
```

---

## 3. MODULES BACKEND

### 3.1 Module Gestion Tenants

#### 3.1.1 FonctionnalitÃ©s

**CrÃ©ation tenant:**
- Provisioning automatique
- Configuration initiale (branding, devise, langue, timezone)
- GÃ©nÃ©ration sous-domaine
- Configuration email (SMTP custom)
- Limites par plan (sites, unitÃ©s, utilisateurs)
- Activation/dÃ©sactivation features

**Gestion tenant:**
- CRUD complet tenants
- Upgrade/downgrade plans
- Gestion facturation tenant
- Statistiques utilisation (storage, bandwidth, API calls)
- Logs activitÃ©
- Backup/restore tenant-specific

#### 3.1.2 Base de donnÃ©es

```sql
-- Table tenants
CREATE TABLE tenants (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    uuid UUID UNIQUE NOT NULL,
    company_name VARCHAR(255) NOT NULL,
    subdomain VARCHAR(100) UNIQUE NOT NULL,
    custom_domain VARCHAR(255) NULL,
    status ENUM('active', 'suspended', 'trial', 'cancelled') DEFAULT 'active',
    plan_id BIGINT NOT NULL,
    trial_ends_at TIMESTAMP NULL,
    
    -- Branding
    logo_url VARCHAR(500),
    primary_color VARCHAR(7),
    secondary_color VARCHAR(7),
    
    -- Configuration
    default_currency VARCHAR(3) DEFAULT 'EUR',
    default_language VARCHAR(5) DEFAULT 'fr',
    timezone VARCHAR(50) DEFAULT 'Europe/Brussels',
    date_format VARCHAR(20) DEFAULT 'd/m/Y',
    
    -- Limites
    max_sites INT DEFAULT 1,
    max_units INT DEFAULT 100,
    max_users INT DEFAULT 50,
    
    -- Features activÃ©es
    features JSON,
    
    -- Metadata
    settings JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

-- Table plans
CREATE TABLE plans (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    price_monthly DECIMAL(10,2),
    price_yearly DECIMAL(10,2),
    currency VARCHAR(3) DEFAULT 'EUR',
    
    -- Limites incluses
    included_sites INT DEFAULT 1,
    included_units INT DEFAULT 100,
    included_users INT DEFAULT 10,
    
    -- Prix additionnels
    extra_site_price DECIMAL(10,2),
    extra_unit_price DECIMAL(10,2),
    extra_user_price DECIMAL(10,2),
    
    -- Features
    features JSON,
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3.2 Module Gestion Sites (Facilities)

#### 3.2.1 FonctionnalitÃ©s

**Gestion des sites:**
- CRUD complet sites/installations
- Multi-sites avec navigation rapide
- Configuration par site:
  - Informations gÃ©nÃ©rales (nom, adresse, tÃ©lÃ©phone, email)
  - Horaires d'ouverture (avec gestion jours fÃ©riÃ©s)
  - Description dÃ©taillÃ©e (markdown support)
  - Galerie photos
  - Localisation GPS (maps integration)
  - Amenities (ascenseur, parking, climatisation, etc.)
  - Instructions d'accÃ¨s
  - Contact emergency

**Carte interactive du site:**
- Vue plan 2D customisable
- CrÃ©ation/modification layout
- Positionnement unitÃ©s
- Code couleur par statut (disponible/occupÃ©e/rÃ©servÃ©e/maintenance)
- Drag & drop pour rÃ©organiser
- NumÃ©rotation automatique
- Sections/Ã©tages
- Filtrage et recherche visuelle
- Export/Import layout

**Configuration avancÃ©e:**
- Restrictions de rÃ©servation (age minimum, types acceptÃ©s)
- Frais de retard personnalisÃ©s
- Politique d'annulation
- Assurance obligatoire/optionnelle
- DÃ©pÃ´t de garantie
- Gate code management
- Access control integration

#### 3.2.2 Base de donnÃ©es

```sql
-- Table sites
CREATE TABLE sites (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    uuid UUID UNIQUE NOT NULL,
    site_code VARCHAR(50) NOT NULL, -- Code court pour URLs
    
    -- Informations gÃ©nÃ©rales
    name VARCHAR(255) NOT NULL,
    description TEXT,
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    state VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(2) DEFAULT 'BE',
    
    -- Contact
    phone VARCHAR(50),
    email VARCHAR(255),
    emergency_contact VARCHAR(255),
    
    -- Localisation
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- Horaires (JSON format)
    opening_hours JSON,
    special_hours JSON, -- Jours fÃ©riÃ©s
    
    -- Configuration
    timezone VARCHAR(50),
    currency VARCHAR(3),
    tax_rate DECIMAL(5,2) DEFAULT 0,
    
    -- Features
    features JSON, -- ['elevator', 'climate_control', 'parking', '24_7_access']
    
    -- Access control
    gate_code VARCHAR(50),
    access_instructions TEXT,
    
    -- Policies
    late_fee_amount DECIMAL(10,2),
    late_fee_days INT DEFAULT 5,
    cancellation_policy TEXT,
    minimum_rental_period INT DEFAULT 1, -- mois
    
    -- Metadata
    settings JSON,
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    UNIQUE KEY unique_site_code (tenant_id, site_code)
);

-- Table site_amenities
CREATE TABLE site_amenities (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT NOT NULL,
    amenity_type VARCHAR(100), -- 'elevator', 'parking', 'climate_control', etc.
    name VARCHAR(255),
    description TEXT,
    icon VARCHAR(100),
    is_featured BOOLEAN DEFAULT FALSE,
    sort_order INT DEFAULT 0,
    
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE
);

-- Table site_images
CREATE TABLE site_images (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT NOT NULL,
    image_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    title VARCHAR(255),
    description TEXT,
    is_primary BOOLEAN DEFAULT FALSE,
    sort_order INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE
);

-- Table site_map (pour carte interactive)
CREATE TABLE site_maps (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    site_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    floor_level INT DEFAULT 0,
    map_data JSON, -- Configuration complÃ¨te du layout
    background_image_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE
);
```

### 3.3 Module Gestion UnitÃ©s (Units)

#### 3.3.1 FonctionnalitÃ©s

**Types d'unitÃ©s:**
- CrÃ©ation/gestion types d'unitÃ©s (ex: 5x5, 10x10, 10x20)
- Dimensions (longueur, largeur, hauteur)
- Volume calculÃ© automatiquement
- CatÃ©gories (small, medium, large, climate-controlled)
- Features par type (climat, accÃ¨s 24/7, etc.)
- Prix de base par type
- Description et conseils d'utilisation
- Images/photos du type
- Recommandations de stockage

**Gestion unitÃ©s individuelles:**
- CRUD complet unitÃ©s
- NumÃ©rotation automatique/manuelle
- Association Ã  un site
- Association Ã  un type
- Localisation sur la carte du site
- Statut en temps rÃ©el:
  - Available (disponible)
  - Reserved (rÃ©servÃ©e)
  - Occupied (occupÃ©e)
  - Maintenance (hors service)
  - Overdue (paiement en retard)
- Historique occupation
- Code d'accÃ¨s unique par unitÃ©
- Notes internes
- Documents attachÃ©s

**Pricing dynamique:**
- Prix de base par type
- Ajustements individuels par unitÃ©
- Prix saisonniers
- Promotions automatiques
- Tarifs spÃ©ciaux (students, seniors, corporate)
- Gestion de la disponibilitÃ© et pricing intelligent

#### 3.3.2 Base de donnÃ©es

```sql
-- Table unit_types
CREATE TABLE unit_types (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    site_id BIGINT NOT NULL,
    uuid UUID UNIQUE NOT NULL,
    
    -- Identification
    name VARCHAR(255) NOT NULL, -- ex: "5x5 Climate Controlled"
    code VARCHAR(50) NOT NULL, -- ex: "5x5-cc"
    category ENUM('small', 'medium', 'large', 'extra_large') DEFAULT 'medium',
    
    -- Dimensions
    length DECIMAL(6,2) NOT NULL, -- mÃ¨tres
    width DECIMAL(6,2) NOT NULL,
    height DECIMAL(6,2),
    volume DECIMAL(10,2) GENERATED ALWAYS AS (length * width * COALESCE(height, 2.5)) STORED,
    
    -- Unit systÃ¨me
    measurement_unit ENUM('metric', 'imperial') DEFAULT 'metric',
    
    -- Pricing
    base_price_monthly DECIMAL(10,2) NOT NULL,
    deposit_amount DECIMAL(10,2) DEFAULT 0,
    
    -- Description
    description TEXT,
    features JSON, -- ['climate_control', 'ground_floor', 'drive_up']
    recommended_for TEXT, -- "IdÃ©al pour: meubles d'une chambre, cartons..."
    
    -- Images
    primary_image_url VARCHAR(500),
    images JSON, -- array d'URLs
    
    -- DisponibilitÃ©
    total_units INT DEFAULT 0,
    is_bookable BOOLEAN DEFAULT TRUE,
    sort_order INT DEFAULT 0,
    
    -- Metadata
    settings JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
    UNIQUE KEY unique_unit_type_code (site_id, code)
);

-- Table units (unitÃ©s individuelles)
CREATE TABLE units (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    site_id BIGINT NOT NULL,
    unit_type_id BIGINT NOT NULL,
    uuid UUID UNIQUE NOT NULL,
    
    -- Identification
    unit_number VARCHAR(50) NOT NULL, -- ex: "A-105"
    barcode VARCHAR(100) UNIQUE,
    
    -- Localisation
    floor_level INT DEFAULT 0,
    section VARCHAR(50), -- ex: "Building A"
    position_x INT, -- Position sur la carte
    position_y INT,
    
    -- Statut
    status ENUM('available', 'reserved', 'occupied', 'maintenance', 'overdue') DEFAULT 'available',
    
    -- Access control
    access_code VARCHAR(20),
    gate_code VARCHAR(20),
    
    -- Pricing (peut override le type)
    custom_price DECIMAL(10,2) NULL,
    
    -- Current rental
    current_rental_id BIGINT NULL,
    occupied_since TIMESTAMP NULL,
    
    -- Metadata
    notes TEXT, -- Notes internes
    settings JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_type_id) REFERENCES unit_types(id) ON DELETE CASCADE,
    UNIQUE KEY unique_unit_number (site_id, unit_number),
    INDEX idx_status (status),
    INDEX idx_unit_type (unit_type_id)
);

-- Table unit_access_logs (logs d'accÃ¨s)
CREATE TABLE unit_access_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    unit_id BIGINT NOT NULL,
    user_id BIGINT NULL,
    access_type ENUM('gate', 'unit', 'manager') DEFAULT 'unit',
    access_method ENUM('code', 'card', 'mobile', 'manual') DEFAULT 'code',
    status ENUM('granted', 'denied') DEFAULT 'granted',
    accessed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (unit_id) REFERENCES units(id) ON DELETE CASCADE,
    INDEX idx_unit_accessed (unit_id, accessed_at)
);
```

### 3.4 Module Gestion Utilisateurs

#### 3.4.1 Types d'utilisateurs

**1. Super Admin (Platform)**
- Gestion tous tenants
- Configuration globale
- Monitoring systÃ¨me
- Support

**2. Admin Tenant**
- Gestion complÃ¨te tenant
- Configuration sites
- Gestion Ã©quipe
- Finances et rapports

**3. Manager Site**
- Gestion d'un ou plusieurs sites
- Gestion clients
- Move-in/move-out
- Facturation
- Support client

**4. Staff/OpÃ©rateur**
- AccÃ¨s limitÃ© lecture
- Gestion move-in/out basique
- Support client basique

**5. Client/Customer**
- RÃ©servation en ligne
- Gestion compte
- Paiements
- Support tickets

**6. Driver (pour valet storage)**
- App mobile dÃ©diÃ©e
- Gestion livraisons/collectes
- Scan items
- Navigation

#### 3.4.2 FonctionnalitÃ©s gestion utilisateurs

**Admin Users:**
- CRUD complet utilisateurs
- SystÃ¨me de rÃ´les et permissions granulaires
- Multi-rÃ´les par utilisateur
- Permissions par site
- Gestion Ã©quipe
- Invitation par email
- Onboarding automatisÃ©
- 2FA obligatoire/optionnel
- SSO (Azure AD, Google Workspace)
- Historique activitÃ©
- Sessions actives
- Logs de connexion

**Customer Users:**
- Auto-registration depuis booking portal
- Profil complet (contact, facturation)
- Documents KYC (ID, proof of address)
- Payment methods management
- Communication preferences
- Custom fields
- Tags et segments
- Notes internes
- Historique complet
- Loyalty program

#### 3.4.3 Base de donnÃ©es

```sql
-- Table users
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NULL, -- NULL pour super admin
    uuid UUID UNIQUE NOT NULL,
    
    -- Authentification
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email_verified_at TIMESTAMP NULL,
    
    -- Informations personnelles
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    phone VARCHAR(50),
    mobile VARCHAR(50),
    date_of_birth DATE,
    
    -- Adresse principale
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    state VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(2),
    
    -- Facturation (peut diffÃ©rer de l'adresse principale)
    billing_address JSON,
    
    -- Type et statut
    user_type ENUM('super_admin', 'tenant_admin', 'manager', 'staff', 'customer', 'driver') DEFAULT 'customer',
    status ENUM('active', 'inactive', 'suspended', 'pending') DEFAULT 'pending',
    
    -- SÃ©curitÃ©
    two_factor_secret VARCHAR(255),
    two_factor_enabled BOOLEAN DEFAULT FALSE,
    last_login_at TIMESTAMP NULL,
    last_login_ip VARCHAR(50),
    
    -- PrÃ©fÃ©rences
    language VARCHAR(5) DEFAULT 'fr',
    timezone VARCHAR(50),
    communication_preferences JSON,
    
    -- KYC
    kyc_status ENUM('pending', 'verified', 'rejected') DEFAULT 'pending',
    kyc_documents JSON,
    
    -- Customer specific
    customer_reference VARCHAR(100), -- numÃ©ro client
    customer_segment VARCHAR(50), -- 'residential', 'business', 'student'
    tags JSON,
    
    -- Metadata
    settings JSON,
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    INDEX idx_email (email),
    INDEX idx_tenant (tenant_id),
    INDEX idx_user_type (user_type)
);

-- Table roles
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NULL,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    description TEXT,
    permissions JSON, -- Array de permissions
    is_system BOOLEAN DEFAULT FALSE, -- RÃ´les systÃ¨me non modifiables
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    UNIQUE KEY unique_role_slug (tenant_id, slug)
);

-- Table user_roles
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    site_id BIGINT NULL, -- Permission limitÃ©e Ã  un site spÃ©cifique
    
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_role (user_id, role_id, site_id)
);

-- Table user_documents
CREATE TABLE user_documents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    document_type VARCHAR(50), -- 'id_card', 'proof_of_address', 'contract'
    file_url VARCHAR(500) NOT NULL,
    original_filename VARCHAR(255),
    mime_type VARCHAR(100),
    file_size INT,
    
    -- Verification
    is_verified BOOLEAN DEFAULT FALSE,
    verified_by BIGINT NULL,
    verified_at TIMESTAMP NULL,
    
    notes TEXT,
    
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (verified_by) REFERENCES users(id)
);

-- Table user_payment_methods
CREATE TABLE user_payment_methods (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    payment_type ENUM('card', 'sepa', 'bank_account', 'paypal') DEFAULT 'card',
    
    -- Stripe/Payment gateway
    gateway_id VARCHAR(100), -- Ex: Stripe customer ID
    payment_method_id VARCHAR(255), -- Ex: Stripe payment method ID
    
    -- Informations masquÃ©es
    last4 VARCHAR(4),
    brand VARCHAR(50), -- 'visa', 'mastercard'
    exp_month INT,
    exp_year INT,
    
    -- SEPA
    iban_last4 VARCHAR(4),
    bank_name VARCHAR(255),
    
    is_default BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 3.5 Module RÃ©servations (Rentals)

#### 3.5.1 Processus de rÃ©servation

**Ã‰tapes:**
1. SÃ©lection site
2. SÃ©lection type d'unitÃ©
3. Choix date de dÃ©but
4. Ajout de produits/services (assurance, cadenas, cartons)
5. Informations client (crÃ©ation compte ou login)
6. Upload documents si requis
7. Signature Ã©lectronique du contrat
8. Paiement (premier mois + dÃ©pÃ´t)
9. Confirmation + code d'accÃ¨s

**Types de rÃ©servations:**
- Immediate move-in (aujourd'hui)
- Future move-in (date future)
- Hold/Reserve (rÃ©servation temporaire)

#### 3.5.2 Gestion des Move-ins/Move-outs

**Move-in workflow:**
- GÃ©nÃ©ration automatique d'une "job"
- Checklist de tÃ¢ches
- Verification documents
- GÃ©nÃ©ration code d'accÃ¨s
- Activation dans access control system
- Email/SMS de bienvenue avec instructions
- Formation vidÃ©o optionnelle

**Move-out workflow:**
- Demande par client ou manager
- Notice period (30 jours gÃ©nÃ©ralement)
- Inspection unitÃ© (photos avant/aprÃ¨s)
- Calcul prorata
- Restitution dÃ©pÃ´t de garantie
- DÃ©sactivation accÃ¨s
- Nettoyage unitÃ©
- Facturation finale
- Feedback request

#### 3.5.3 Base de donnÃ©es

```sql
-- Table rentals
CREATE TABLE rentals (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    site_id BIGINT NOT NULL,
    unit_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    uuid UUID UNIQUE NOT NULL,
    
    -- RÃ©fÃ©rence
    rental_number VARCHAR(50) UNIQUE NOT NULL, -- ex: "RNT-2024-00001"
    
    -- Dates
    reservation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    move_in_date DATE NOT NULL,
    move_out_date DATE NULL,
    notice_date DATE NULL, -- Date de prÃ©avis
    expected_move_out_date DATE NULL,
    
    -- Statut
    status ENUM(
        'pending_documents', 
        'pending_payment', 
        'reserved', 
        'active', 
        'notice_given',
        'overdue', 
        'terminated', 
        'cancelled'
    ) DEFAULT 'pending_documents',
    
    -- Pricing
    monthly_rate DECIMAL(10,2) NOT NULL,
    deposit_amount DECIMAL(10,2) DEFAULT 0,
    setup_fee DECIMAL(10,2) DEFAULT 0,
    
    -- Billing
    billing_cycle VARCHAR(20) DEFAULT 'monthly', -- 'monthly', 'quarterly', 'yearly'
    billing_day INT DEFAULT 1, -- Jour du mois
    next_billing_date DATE,
    auto_pay_enabled BOOLEAN DEFAULT FALSE,
    
    -- Promotions
    promotion_id BIGINT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    discount_type ENUM('fixed', 'percentage') NULL,
    discount_months INT DEFAULT 0, -- DurÃ©e en mois
    
    -- Contrat
    contract_signed BOOLEAN DEFAULT FALSE,
    contract_signed_at TIMESTAMP NULL,
    contract_signature_ip VARCHAR(50),
    contract_pdf_url VARCHAR(500),
    
    -- Access
    access_code VARCHAR(20),
    gate_code VARCHAR(20),
    
    -- Insurance
    insurance_required BOOLEAN DEFAULT FALSE,
    insurance_provider VARCHAR(255),
    insurance_policy_number VARCHAR(100),
    
    -- Metadata
    settings JSON,
    notes TEXT,
    cancellation_reason TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (site_id) REFERENCES sites(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_id) REFERENCES units(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_user (user_id),
    INDEX idx_dates (move_in_date, move_out_date)
);

-- Table rental_jobs (tÃ¢ches move-in/move-out)
CREATE TABLE rental_jobs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rental_id BIGINT NOT NULL,
    job_type ENUM('move_in', 'move_out', 'inspection', 'maintenance') DEFAULT 'move_in',
    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
    
    scheduled_date DATE,
    completed_at TIMESTAMP NULL,
    completed_by BIGINT NULL,
    
    -- Checklist
    checklist JSON, -- Array d'objets {task: '', completed: bool, notes: ''}
    
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (rental_id) REFERENCES rentals(id) ON DELETE CASCADE,
    FOREIGN KEY (completed_by) REFERENCES users(id)
);

-- Table rental_documents
CREATE TABLE rental_documents (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rental_id BIGINT NOT NULL,
    document_type VARCHAR(50), -- 'contract', 'id', 'insurance', 'inspection_photo'
    file_url VARCHAR(500) NOT NULL,
    original_filename VARCHAR(255),
    mime_type VARCHAR(100),
    
    uploaded_by BIGINT NULL,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (rental_id) REFERENCES rentals(id) ON DELETE CASCADE,
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

-- Table rental_products (produits additionnels)
CREATE TABLE rental_products (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    rental_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    
    quantity INT DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    
    is_recurring BOOLEAN DEFAULT FALSE, -- Si facturÃ© mensuellement
    
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (rental_id) REFERENCES rentals(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id)
);
```

### 3.6 Module Produits & Services

#### 3.6.1 FonctionnalitÃ©s

**Types de produits:**
- One-time products (cadenas, cartons, protection meubles)
- Recurring services (assurance mensuelle, nettoyage)
- Add-ons (accÃ¨s Ã©tendu, parking)

**Gestion:**
- CRUD complet produits
- CatÃ©gorisation
- Pricing par site/tenant
- Stock management (pour produits physiques)
- Images et descriptions
- VisibilitÃ© sur booking portal
- Bundling (packs)
- Upsell automatique

#### 3.6.2 Base de donnÃ©es

```sql
-- Table products
CREATE TABLE products (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    uuid UUID UNIQUE NOT NULL,
    
    -- Identification
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) NOT NULL,
    sku VARCHAR(100) UNIQUE,
    category VARCHAR(100), -- 'insurance', 'lock', 'boxes', 'parking'
    
    -- Description
    description TEXT,
    short_description VARCHAR(500),
    
    -- Images
    image_url VARCHAR(500),
    gallery_images JSON,
    
    -- Pricing
    price DECIMAL(10,2) NOT NULL,
    cost_price DECIMAL(10,2), -- Prix de revient
    currency VARCHAR(3) DEFAULT 'EUR',
    tax_rate DECIMAL(5,2) DEFAULT 0,
    
    -- Type
    product_type ENUM('one_time', 'recurring', 'addon') DEFAULT 'one_time',
    
    -- Stock (pour produits physiques)
    track_stock BOOLEAN DEFAULT FALSE,
    stock_quantity INT DEFAULT 0,
    low_stock_threshold INT DEFAULT 5,
    
    -- Availability
    is_available BOOLEAN DEFAULT TRUE,
    available_sites JSON, -- Array de site_ids
    
    -- Display
    is_featured BOOLEAN DEFAULT FALSE,
    display_order INT DEFAULT 0,
    show_on_booking_portal BOOLEAN DEFAULT TRUE,
    
    -- Metadata
    settings JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    UNIQUE KEY unique_product_slug (tenant_id, slug)
);

-- Table product_bundles
CREATE TABLE product_bundles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    bundle_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- Table product_bundle_items
CREATE TABLE product_bundle_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    bundle_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT DEFAULT 1,
    
    FOREIGN KEY (bundle_id) REFERENCES product_bundles(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);
```

---

## 4. MODULES FRONTEND

### 4.1 Portal d'Administration (Management Portal)

#### 4.1.1 Dashboard Principal

**MÃ©triques en temps rÃ©el:**
- Taux d'occupation global et par site
- Revenus du mois (actuel vs prÃ©cÃ©dent)
- Nouveaux clients
- Move-ins/Move-outs planifiÃ©s
- Paiements en attente
- UnitÃ©s en retard de paiement
- Tickets support ouverts

**Graphiques:**
- Ã‰volution occupation (12 derniers mois)
- Revenus mensuels (trend line)
- Types d'unitÃ©s les plus populaires
- Sources d'acquisition clients
- Performance par site

**Quick actions:**
- Nouveau move-in
- Rechercher client/unitÃ©
- GÃ©nÃ©rer rapport
- Voir calendrier jobs

#### 4.1.2 Navigation & UX

**Menu principal:**
```
ðŸ“Š Dashboard
ðŸ¢ Sites
  - Liste des sites
  - CrÃ©er nouveau site
  - Carte interactive
  
ðŸ“¦ UnitÃ©s
  - Tous les types d'unitÃ©s
  - Toutes les unitÃ©s
  - DisponibilitÃ©
  - Maintenance
  
ðŸ‘¥ Utilisateurs
  - Clients
  - Ã‰quipe
  - RÃ´les & Permissions
  
ðŸ“‹ RÃ©servations
  - Actives
  - En attente
  - PrÃ©avis
  - Historique
  
ðŸ’° Facturation
  - Factures
  - Paiements
  - Retards
  - Rapprochement
  
ðŸ“¦ Valet Storage
  - Commandes
  - Livraisons
  - Inventaire
  - Drivers
  
ðŸ›ï¸ Produits & Services
  - Catalogue
  - Stock
  - Bundles
  
ðŸ“ˆ Rapports & Analytics
  - Occupation
  - Revenus
  - Clients
  - Rapports personnalisÃ©s
  
ðŸŽ« Support
  - Tickets
  - Chat en ligne
  - Base de connaissances
  
âš™ï¸ Configuration
  - GÃ©nÃ©ral
  - Sites
  - Facturation
  - Emails
  - IntÃ©grations
  - API Keys
  
ðŸ”§ Outils
  - Import/Export
  - Webhooks
  - Logs
  - Backup
```

**Barre de recherche globale:**
- Recherche unifiÃ©e: clients, unitÃ©s, factures, commandes
- Raccourcis clavier (Cmd/Ctrl + K)
- RÃ©sultats groupÃ©s par type
- AccÃ¨s direct aux actions

**Notifications:**
- Centre de notifications en temps rÃ©el
- Filtrage par type
- Actions rapides
- Historique

#### 4.1.3 Gestion Sites - Interface

**Vue liste:**
- Carte avec tous les sites
- Liste avec statistiques par site
- Filtres: statut, occupation, revenus
- Actions rapides: Ã©diter, voir dÃ©tails, accÃ©der au site

**DÃ©tails site:**
```
Tabs:
1. Vue d'ensemble
   - Statistiques clÃ©s
   - Graphique occupation
   - Revenus
   
2. DÃ©tails & Configuration
   - Informations gÃ©nÃ©rales
   - Horaires
   - Contact
   - Localisation
   
3. UnitÃ©s
   - Liste des types d'unitÃ©s
   - UnitÃ©s individuelles
   - Carte interactive
   
4. Amenities
   - Liste des Ã©quipements
   - Gestion
   
5. Images
   - Galerie
   - Upload bulk
   
6. Configuration avancÃ©e
   - Restrictions
   - Frais
   - Policies
   
7. IntÃ©grations
   - Access control
   - Accounting
```

**Carte interactive:**
- Ã‰diteur drag & drop
- Outils de dessin (rectangle, cercle, polygone)
- NumÃ©rotation automatique
- Code couleur statuts
- Zoom et pan
- Layers (Ã©tages)
- Export PNG/PDF
- Import existant

#### 4.1.4 Gestion Clients - Interface

**Vue liste clients:**
- Tableau avec colonnes:
  - Nom
  - Email/TÃ©lÃ©phone
  - Site(s) louÃ©(s)
  - Statut compte
  - Balance
  - DerniÃ¨re activitÃ©
- Filtres avancÃ©s:
  - Statut
  - Site
  - Type de client (rÃ©sidentiel/business)
  - Tags
  - Balance positive/nÃ©gative
- Export Excel/CSV
- Actions bulk

**DÃ©tail client:**
```
Tabs:
1. Profil
   - Informations personnelles
   - Contact
   - Adresses
   - Documents KYC
   
2. RÃ©servations
   - Actives
   - PassÃ©es
   - Quick actions
   
3. Facturation
   - Factures
   - Paiements
   - Moyens de paiement
   - Balance
   
4. Communications
   - Historique emails/SMS
   - Notes internes
   - Support tickets
   
5. Documents
   - Contrats signÃ©s
   - Documents uploadÃ©s
   - Factures PDF
   
6. ActivitÃ©
   - Timeline complÃ¨te
   - Logs d'accÃ¨s
   - Modifications
```

**Actions rapides:**
- Envoyer email/SMS
- CrÃ©er nouvelle rÃ©servation
- GÃ©nÃ©rer facture manuelle
- Ajouter note
- Voir unitÃ© sur carte
- AccÃ¨s temporaire
- Suspend account

### 4.2 Portal Client (Customer Booking Portal)

#### 4.2.1 Homepage

**Hero section:**
- Titre accrocheur
- Recherche rapide par localisation
- CTA principal: "RÃ©server maintenant"
- Photo/vidÃ©o qualitÃ©

**Sections:**
1. **SÃ©lection site** (si multi-sites)
   - Carte interactive
   - Liste avec distances
   - Filtres: ville, amenities
   
2. **Types d'unitÃ©s populaires**
   - Grid avec photos
   - Prix starting at
   - Dimensions
   - Quick CTA
   
3. **Comment Ã§a marche**
   - 3-4 Ã©tapes simples
   - IcÃ´nes
   
4. **Pourquoi nous choisir**
   - Security
   - FlexibilitÃ©
   - AccÃ¨s 24/7
   - Etc.
   
5. **Testimonials**
   
6. **FAQ**

7. **CTA final**

#### 4.2.2 Processus de rÃ©servation

**Ã‰tape 1: SÃ©lection site**
```
Si mono-site: skip
Si multi-sites:
- Carte interactive
- Liste sites avec:
  - Distance
  - DisponibilitÃ©
  - Prix Ã  partir de
  - Quick view amenities
  
Options filtrage:
- Ville
- Distance max
- Climate control
- 24/7 access
- Prix range
```

**Ã‰tape 2: SÃ©lection type d'unitÃ©**
```
Layout grid:
- Photo unitÃ© type
- Dimensions (LxWxH)
- Volume
- Prix/mois
- Badge "Populaire" si top seller
- "RecommandÃ© pour: X"
- Nombre disponible

Sidebar:
- Filtres:
  - Taille (small, medium, large)
  - Prix range
  - Features
- Calculateur espace
- Chat support

Actions:
- Voir dÃ©tails (modal)
- SÃ©lectionner
```

**Ã‰tape 3: Date de dÃ©but & Options**
```
Date picker:
- Move-in date
- Calcul prorata si mid-month

Duration selector:
- Monthly
- 3 months
- 6 months
- 12 months (avec discount)

Produits additionnels:
- Assurance (required/optional)
- Cadenas
- Cartons de dÃ©mÃ©nagement
- Parking spot
- Etc.

RÃ©sumÃ© prix:
- Prix mensuel
- Prorata premier mois
- Setup fee
- DÃ©pÃ´t
- Total dÃ» aujourd'hui
- Total mensuel rÃ©current
```

**Ã‰tape 4: Informations compte**
```
Si non connectÃ©:
- "DÃ©jÃ  client? Se connecter"
- Formulaire inscription:
  - PrÃ©nom, Nom
  - Email
  - TÃ©lÃ©phone
  - Password
  - Accepter T&C
  
Si connectÃ©:
- PrÃ©-remplir info
- Ã‰diter si besoin

Adresse:
- ComplÃ¨te
- Autocomplete Google
```

**Ã‰tape 5: Documents** (si requis)
```
Upload:
- PiÃ¨ce d'identitÃ© (front/back)
- Justificatif de domicile
- Autres selon config tenant

Acceptation:
- Instant si vÃ©rification auto
- Ou "En attente vÃ©rification"
```

**Ã‰tape 6: Signature Ã©lectronique**
```
- Affichage contrat PDF
- Zones de signature
- Initiales requises
- Signature tactile/souris
- Option print
```

**Ã‰tape 7: Paiement**
```
Moyens acceptÃ©s:
- Carte bancaire (Stripe)
- SEPA Direct Debit
- PayPal
- Virement (avec validation manuelle)

Formulaire paiement:
- SÃ©curisÃ© (PCI DSS)
- Save pour auto-pay futur
- 3D Secure si requis

RÃ©sumÃ© final:
- Montant Ã  payer
- Breakdown
```

**Confirmation:**
```
Page success:
- NumÃ©ro de rÃ©servation
- Code d'accÃ¨s (si immediate)
- Instructions accÃ¨s
- Email confirmation envoyÃ©
- Option print
- Ajouter au calendrier
- Download contrat PDF

Actions suivantes:
- Aller au dashboard
- Ajouter produits
- Contacter support
```

#### 4.2.3 Dashboard Client

**Menu:**
```
ðŸ  Dashboard
ðŸ“¦ Mes Locations
ðŸ’³ Facturation & Paiements
ðŸ‘¤ Mon Profil
ðŸ“„ Documents
ðŸ’¬ Support
```

**Dashboard:**
```
Widgets:
1. Mes locations actives
   - Photo unitÃ©
   - NumÃ©ro unitÃ©
   - Site
   - Prix mensuel
   - Prochaine facturation
   - Quick access code
   - Actions: Voir dÃ©tails, Give notice, Add products
   
2. Paiements Ã  venir
   - Montant
   - Date
   - Moyen paiement
   - Action: Pay now
   
3. Messages rÃ©cents
   
4. Quick actions:
   - Nouvelle rÃ©servation
   - Update payment method
   - Contact support
   - Download invoices
```

**Mes Locations - DÃ©tail:**
```
Tabs:
1. Overview
   - Informations unitÃ©
   - Dates
   - Pricing
   - Access codes
   - Photos unitÃ©
   
2. Facturation
   - Factures
   - Paiements
   - Auto-pay on/off
   
3. Produits & Services
   - Liste current
   - Add new
   
4. Documents
   - Contrat signÃ©
   - Factures
   - Autres documents
   
5. Give Notice
   - Formulaire prÃ©avis
   - Calcul date fin
   - Instructions move-out
```

**Facturation:**
```
- Liste toutes factures
- Filtres: payÃ©, en attente, overdue
- Download PDF
- Pay now pour pending
- RÃ©current vs one-time
- Export history

Moyens de paiement:
- Liste saved
- Add new
- Set default
- Remove
```

**Profil:**
```
Sections:
1. Informations personnelles
   - Ã‰diter
   
2. Adresses
   - Principale
   - Facturation
   - Autres
   
3. Contact
   - Email (verified)
   - TÃ©lÃ©phone (verified)
   - PrÃ©fÃ©rences communication
   
4. SÃ©curitÃ©
   - Change password
   - Enable 2FA
   - Sessions actives
   - Logout all devices
   
5. Notifications
   - Email preferences
   - SMS preferences
```

### 4.3 Progressive Web App (PWA) Features

**CaractÃ©ristiques:**
- Installable sur mobile/desktop
- Offline-first (service workers)
- Push notifications
- Add to home screen
- Native-like experience

**Features mobiles spÃ©cifiques:**
- Scan QR codes accÃ¨s
- Scan barcode produits valet
- Geolocation pour trouver site
- Photo upload optimisÃ©
- Touch optimizations

---

## 5. SYSTÃˆME DE RÃ‰SERVATION EN LIGNE

### 5.1 Booking Engine

#### 5.1.1 Architecture

**Components:**
```
BookingEngine/
â”œâ”€â”€ SiteSelector/
â”œâ”€â”€ UnitTypeSelector/
â”‚   â”œâ”€â”€ UnitTypeCard
â”‚   â”œâ”€â”€ UnitTypeDetail
â”‚   â””â”€â”€ SpaceCalculator
â”œâ”€â”€ DateSelector/
â”œâ”€â”€ ProductsSelector/
â”œâ”€â”€ CustomerForm/
â”œâ”€â”€ DocumentUpload/
â”œâ”€â”€ ContractSigning/
â”œâ”€â”€ Payment/
â””â”€â”€ Confirmation/
```

#### 5.1.2 APIs Backend

```php
// Routes API
Route::prefix('booking')->group(function() {
    // Step 1: Sites
    Route::get('sites', [BookingController::class, 'getSites']);
    Route::get('sites/{site}/availability', [BookingController::class, 'getSiteAvailability']);
    
    // Step 2: Unit Types
    Route::get('sites/{site}/unit-types', [BookingController::class, 'getUnitTypes']);
    Route::get('unit-types/{unitType}/availability', [BookingController::class, 'checkAvailability']);
    
    // Step 3: Date & Products
    Route::get('products', [BookingController::class, 'getProducts']);
    Route::post('calculate-price', [BookingController::class, 'calculatePrice']);
    
    // Step 4: Create reservation (sans paiement)
    Route::post('reservations', [BookingController::class, 'createReservation']);
    
    // Step 5: Documents
    Route::post('reservations/{reservation}/documents', [BookingController::class, 'uploadDocuments']);
    
    // Step 6: Contract
    Route::get('reservations/{reservation}/contract', [BookingController::class, 'getContract']);
    Route::post('reservations/{reservation}/sign', [BookingController::class, 'signContract']);
    
    // Step 7: Payment
    Route::post('reservations/{reservation}/payment', [BookingController::class, 'processPayment']);
    Route::post('reservations/{reservation}/payment/confirm', [BookingController::class, 'confirmPayment']);
    
    // Helpers
    Route::post('space-calculator', [BookingController::class, 'calculateSpace']);
    Route::get('promotions', [BookingController::class, 'getActivePromotions']);
});
```

**Exemple BookingController:**

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Services\BookingService;
use App\Services\PricingService;
use App\Models\Site;
use App\Models\UnitType;
use App\Models\Rental;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class BookingController extends Controller
{
    public function __construct(
        private BookingService $bookingService,
        private PricingService $pricingService
    ) {}
    
    /**
     * Get available sites for booking
     */
    public function getSites(Request $request)
    {
        $tenant = $request->tenant; // InjectÃ© par middleware
        
        $sites = Site::where('tenant_id', $tenant->id)
            ->where('is_active', true)
            ->with(['amenities', 'images'])
            ->withCount(['units as available_units' => function($query) {
                $query->where('status', 'available');
            }])
            ->get()
            ->map(function($site) {
                return [
                    'id' => $site->id,
                    'uuid' => $site->uuid,
                    'code' => $site->site_code,
                    'name' => $site->name,
                    'address' => [
                        'line1' => $site->address_line1,
                        'line2' => $site->address_line2,
                        'city' => $site->city,
                        'postal_code' => $site->postal_code,
                        'country' => $site->country,
                    ],
                    'location' => [
                        'latitude' => $site->latitude,
                        'longitude' => $site->longitude,
                    ],
                    'contact' => [
                        'phone' => $site->phone,
                        'email' => $site->email,
                    ],
                    'opening_hours' => $site->opening_hours,
                    'amenities' => $site->amenities,
                    'images' => $site->images,
                    'available_units' => $site->available_units,
                ];
            });
        
        return response()->json([
            'success' => true,
            'data' => $sites
        ]);
    }
    
    /**
     * Get available unit types for a site
     */
    public function getUnitTypes(Request $request, Site $site)
    {
        $moveInDate = $request->input('move_in_date', now()->format('Y-m-d'));
        
        $unitTypes = UnitType::where('site_id', $site->id)
            ->where('is_bookable', true)
            ->with('images')
            ->withCount(['units as available_units' => function($query) use ($moveInDate) {
                $query->where('status', 'available')
                    ->whereDoesntHave('rentals', function($q) use ($moveInDate) {
                        $q->where('status', 'active')
                          ->where('move_in_date', '<=', $moveInDate)
                          ->where(function($q2) {
                              $q2->whereNull('move_out_date')
                                 ->orWhere('move_out_date', '>=', now());
                          });
                    });
            }])
            ->having('available_units', '>', 0)
            ->orderBy('sort_order')
            ->get()
            ->map(function($unitType) use ($moveInDate) {
                $pricing = $this->pricingService->calculateUnitTypePrice($unitType, $moveInDate);
                
                return [
                    'id' => $unitType->id,
                    'uuid' => $unitType->uuid,
                    'code' => $unitType->code,
                    'name' => $unitType->name,
                    'category' => $unitType->category,
                    'dimensions' => [
                        'length' => $unitType->length,
                        'width' => $unitType->width,
                        'height' => $unitType->height,
                        'volume' => $unitType->volume,
                        'unit' => $unitType->measurement_unit,
                    ],
                    'description' => $unitType->description,
                    'recommended_for' => $unitType->recommended_for,
                    'features' => $unitType->features,
                    'pricing' => $pricing,
                    'images' => $unitType->images,
                    'available_units' => $unitType->available_units,
                ];
            });
        
        return response()->json([
            'success' => true,
            'data' => $unitTypes
        ]);
    }
    
    /**
     * Calculate total price for booking
     */
    public function calculatePrice(Request $request)
    {
        $validated = $request->validate([
            'unit_type_id' => 'required|exists:unit_types,id',
            'move_in_date' => 'required|date|after_or_equal:today',
            'duration_months' => 'nullable|integer|min:1',
            'products' => 'nullable|array',
            'products.*.id' => 'required|exists:products,id',
            'products.*.quantity' => 'required|integer|min:1',
            'promotion_code' => 'nullable|string',
        ]);
        
        $pricing = $this->pricingService->calculateBookingPrice($validated);
        
        return response()->json([
            'success' => true,
            'data' => $pricing
        ]);
    }
    
    /**
     * Create a new reservation
     */
    public function createReservation(Request $request)
    {
        $validated = $request->validate([
            'site_id' => 'required|exists:sites,id',
            'unit_type_id' => 'required|exists:unit_types,id',
            'move_in_date' => 'required|date|after_or_equal:today',
            'customer' => 'required|array',
            'customer.first_name' => 'required|string|max:100',
            'customer.last_name' => 'required|string|max:100',
            'customer.email' => 'required|email',
            'customer.phone' => 'required|string',
            'customer.address' => 'required|array',
            'products' => 'nullable|array',
            'promotion_code' => 'nullable|string',
        ]);
        
        try {
            DB::beginTransaction();
            
            $rental = $this->bookingService->createReservation($validated);
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'RÃ©servation crÃ©Ã©e avec succÃ¨s',
                'data' => [
                    'rental_id' => $rental->id,
                    'rental_uuid' => $rental->uuid,
                    'rental_number' => $rental->rental_number,
                    'status' => $rental->status,
                    'next_step' => $this->getNextStep($rental),
                ]
            ], 201);
            
        } catch (\Exception $e) {
            DB::rollBack();
            
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la crÃ©ation de la rÃ©servation',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Upload required documents
     */
    public function uploadDocuments(Request $request, Rental $rental)
    {
        $validated = $request->validate([
            'documents' => 'required|array',
            'documents.*.type' => 'required|string|in:id_card,proof_of_address,insurance',
            'documents.*.file' => 'required|file|mimes:pdf,jpg,jpeg,png|max:5120', // 5MB
        ]);
        
        try {
            $this->bookingService->uploadDocuments($rental, $validated['documents']);
            
            return response()->json([
                'success' => true,
                'message' => 'Documents uploadÃ©s avec succÃ¨s',
                'data' => [
                    'next_step' => $this->getNextStep($rental),
                ]
            ]);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de l\'upload',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Get contract PDF for signing
     */
    public function getContract(Rental $rental)
    {
        $contract = $this->bookingService->generateContract($rental);
        
        return response()->json([
            'success' => true,
            'data' => [
                'contract_html' => $contract['html'],
                'contract_pdf_url' => $contract['pdf_url'],
                'signature_required' => true,
            ]
        ]);
    }
    
    /**
     * Sign the contract electronically
     */
    public function signContract(Request $request, Rental $rental)
    {
        $validated = $request->validate([
            'signature' => 'required|string', // Base64 image
            'initials' => 'required|string',
            'agreed_to_terms' => 'required|accepted',
        ]);
        
        try {
            $this->bookingService->signContract($rental, $validated);
            
            return response()->json([
                'success' => true,
                'message' => 'Contrat signÃ© avec succÃ¨s',
                'data' => [
                    'next_step' => 'payment',
                ]
            ]);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la signature',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Process payment
     */
    public function processPayment(Request $request, Rental $rental)
    {
        $validated = $request->validate([
            'payment_method' => 'required|string|in:card,sepa,paypal',
            'payment_method_id' => 'required_if:payment_method,card,sepa|string',
            'save_for_future' => 'nullable|boolean',
            'auto_pay_enabled' => 'nullable|boolean',
        ]);
        
        try {
            $result = $this->bookingService->processPayment($rental, $validated);
            
            return response()->json([
                'success' => true,
                'message' => 'Paiement traitÃ© avec succÃ¨s',
                'data' => $result
            ]);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors du paiement',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Confirm payment (for 3D Secure, etc.)
     */
    public function confirmPayment(Request $request, Rental $rental)
    {
        $validated = $request->validate([
            'payment_intent_id' => 'required|string',
        ]);
        
        try {
            $result = $this->bookingService->confirmPayment($rental, $validated);
            
            return response()->json([
                'success' => true,
                'message' => 'Paiement confirmÃ© avec succÃ¨s',
                'data' => $result
            ]);
            
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erreur lors de la confirmation',
                'error' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Get active promotions
     */
    public function getActivePromotions(Request $request)
    {
        $tenant = $request->tenant;
        
        $promotions = Promotion::where('tenant_id', $tenant->id)
            ->where('is_active', true)
            ->where('start_date', '<=', now())
            ->where('end_date', '>=', now())
            ->get();
        
        return response()->json([
            'success' => true,
            'data' => $promotions
        ]);
    }
    
    /**
     * Space calculator helper
     */
    public function calculateSpace(Request $request)
    {
        $validated = $request->validate([
            'items' => 'required|array',
            'items.*.type' => 'required|string',
            'items.*.quantity' => 'required|integer|min:1',
        ]);
        
        $estimatedVolume = $this->bookingService->calculateRequiredSpace($validated['items']);
        
        $recommendedUnitTypes = UnitType::where('volume', '>=', $estimatedVolume)
            ->orderBy('volume')
            ->limit(3)
            ->get();
        
        return response()->json([
            'success' => true,
            'data' => [
                'estimated_volume' => $estimatedVolume,
                'recommended_unit_types' => $recommendedUnitTypes,
            ]
        ]);
    }
    
    /**
     * Helper to determine next step
     */
    private function getNextStep(Rental $rental): string
    {
        if ($rental->status === 'pending_documents') {
            return 'documents';
        }
        if ($rental->status === 'pending_payment' && !$rental->contract_signed) {
            return 'contract';
        }
        if ($rental->status === 'pending_payment') {
            return 'payment';
        }
        return 'complete';
    }
}
```

### 5.2 Pricing Engine

#### 5.2.1 SystÃ¨me de tarification dynamique

**Composants:**
- Prix de base unit type
- Ajustements saisonniers
- Promotions actives
- Discounts durÃ©e (3, 6, 12 mois)
- Tarifs spÃ©ciaux (Ã©tudiants, seniors, corporate)
- Prorata premier mois
- Setup fees
- DÃ©pÃ´t de garantie

**Service PricingService:**

```php
<?php

namespace App\Services;

use App\Models\UnitType;
use App\Models\Promotion;
use Carbon\Carbon;

class PricingService
{
    /**
     * Calculate price for a unit type on a specific date
     */
    public function calculateUnitTypePrice(UnitType $unitType, string $moveInDate): array
    {
        $basePrice = $unitType->base_price_monthly;
        $date = Carbon::parse($moveInDate);
        
        // Seasonal adjustments
        $seasonalPrice = $this->applySeasonalAdjustment($basePrice, $date);
        
        // Check for active promotions
        $promotions = $this->getActivePromotions($unitType, $date);
        $promotionalPrice = $this->applyPromotions($seasonalPrice, $promotions);
        
        // Calculate prorata for first month if mid-month
        $daysInMonth = $date->daysInMonth;
        $daysRemaining = $date->daysInMonth - $date->day + 1;
        $prorataAmount = ($promotionalPrice / $daysInMonth) * $daysRemaining;
        
        return [
            'base_price' => $basePrice,
            'seasonal_price' => $seasonalPrice,
            'promotional_price' => $promotionalPrice,
            'monthly_price' => $promotionalPrice,
            'prorata_amount' => round($prorataAmount, 2),
            'deposit_amount' => $unitType->deposit_amount,
            'promotions' => $promotions,
        ];
    }
    
    /**
     * Calculate full booking price with products
     */
    public function calculateBookingPrice(array $data): array
    {
        $unitType = UnitType::findOrFail($data['unit_type_id']);
        $moveInDate = Carbon::parse($data['move_in_date']);
        
        // Base pricing
        $pricing = $this->calculateUnitTypePrice($unitType, $moveInDate->format('Y-m-d'));
        
        // Duration discount
        $durationMonths = $data['duration_months'] ?? 1;
        $durationDiscount = $this->calculateDurationDiscount($pricing['monthly_price'], $durationMonths);
        
        // Products
        $productsTotal = 0;
        $productsRecurring = 0;
        $productDetails = [];
        
        if (isset($data['products']) && is_array($data['products'])) {
            foreach ($data['products'] as $productData) {
                $product = Product::findOrFail($productData['id']);
                $quantity = $productData['quantity'] ?? 1;
                $productTotal = $product->price * $quantity;
                
                if ($product->product_type === 'recurring') {
                    $productsRecurring += $productTotal;
                } else {
                    $productsTotal += $productTotal;
                }
                
                $productDetails[] = [
                    'id' => $product->id,
                    'name' => $product->name,
                    'quantity' => $quantity,
                    'unit_price' => $product->price,
                    'total_price' => $productTotal,
                    'type' => $product->product_type,
                ];
            }
        }
        
        // Apply promotion code if provided
        $promotionDiscount = 0;
        if (isset($data['promotion_code'])) {
            $promotion = Promotion::where('code', $data['promotion_code'])
                ->where('is_active', true)
                ->where('start_date', '<=', now())
                ->where('end_date', '>=', now())
                ->first();
            
            if ($promotion) {
                $promotionDiscount = $this->calculatePromotionDiscount(
                    $pricing['monthly_price'], 
                    $promotion
                );
            }
        }
        
        // Calculate totals
        $subtotal = $pricing['prorata_amount'] + $productsTotal;
        $monthlyRecurring = $pricing['monthly_price'] + $productsRecurring - $promotionDiscount;
        $deposit = $pricing['deposit_amount'];
        
        // Tax
        $taxRate = $unitType->site->tax_rate ?? 0;
        $tax = ($subtotal + $deposit) * ($taxRate / 100);
        
        $totalDueToday = $subtotal + $deposit + $tax;
        
        return [
            'unit_pricing' => $pricing,
            'duration_months' => $durationMonths,
            'duration_discount' => $durationDiscount,
            'products' => $productDetails,
            'products_one_time_total' => $productsTotal,
            'products_recurring_total' => $productsRecurring,
            'promotion_discount' => $promotionDiscount,
            'subtotal' => round($subtotal, 2),
            'deposit' => round($deposit, 2),
            'tax_rate' => $taxRate,
            'tax_amount' => round($tax, 2),
            'total_due_today' => round($totalDueToday, 2),
            'monthly_recurring' => round($monthlyRecurring, 2),
            'currency' => $unitType->site->currency ?? 'EUR',
        ];
    }
    
    /**
     * Apply seasonal price adjustments
     */
    private function applySeasonalAdjustment(float $basePrice, Carbon $date): float
    {
        // Example: Prix plus Ã©levÃ© en Ã©tÃ© (mai-septembre)
        $month = $date->month;
        
        if ($month >= 5 && $month <= 9) {
            return $basePrice * 1.1; // +10% en Ã©tÃ©
        }
        
        return $basePrice;
    }
    
    /**
     * Get active promotions for unit type
     */
    private function getActivePromotions(UnitType $unitType, Carbon $date): array
    {
        return Promotion::where('tenant_id', $unitType->tenant_id)
            ->where('is_active', true)
            ->where('start_date', '<=', $date)
            ->where('end_date', '>=', $date)
            ->where(function($query) use ($unitType) {
                $query->whereNull('applicable_unit_types')
                    ->orWhereJsonContains('applicable_unit_types', $unitType->id);
            })
            ->get()
            ->map(function($promo) {
                return [
                    'id' => $promo->id,
                    'name' => $promo->name,
                    'code' => $promo->code,
                    'discount_type' => $promo->discount_type,
                    'discount_amount' => $promo->discount_amount,
                ];
            })
            ->toArray();
    }
    
    /**
     * Apply promotions to price
     */
    private function applyPromotions(float $price, array $promotions): float
    {
        foreach ($promotions as $promo) {
            if ($promo['discount_type'] === 'percentage') {
                $price = $price * (1 - $promo['discount_amount'] / 100);
            } else {
                $price = $price - $promo['discount_amount'];
            }
        }
        
        return max($price, 0); // Jamais nÃ©gatif
    }
    
    /**
     * Calculate duration discount
     */
    private function calculateDurationDiscount(float $monthlyPrice, int $months): float
    {
        if ($months >= 12) {
            return $monthlyPrice * 0.15; // 15% pour 12+ mois
        } elseif ($months >= 6) {
            return $monthlyPrice * 0.10; // 10% pour 6+ mois
        } elseif ($months >= 3) {
            return $monthlyPrice * 0.05; // 5% pour 3+ mois
        }
        
        return 0;
    }
    
    /**
     * Calculate promotion discount
     */
    private function calculatePromotionDiscount(float $price, Promotion $promotion): float
    {
        if ($promotion->discount_type === 'percentage') {
            return $price * ($promotion->discount_amount / 100);
        }
        
        return min($promotion->discount_amount, $price);
    }
}
```

---

## 6. MODULE VALET STORAGE

### 6.1 Concept Valet Storage

Le valet storage est un service oÃ¹ l'entreprise vient chercher les affaires du client Ã  son domicile, les stocke dans un entrepÃ´t, et les livre de nouveau sur demande. Les clients ne vont jamais physiquement Ã  l'entrepÃ´t.

### 6.2 Workflow Valet Storage

**Processus complet:**

1. **RÃ©servation en ligne**
   - Client choisit nombre de box/items ou volume
   - SÃ©lection date/heure pickup
   - Adresse pickup
   - Instructions spÃ©ciales
   
2. **Livraison boxes** (optionnel)
   - Livraison boxes vides au client
   - Client emballe ses affaires
   
3. **Collection (Pickup)**
   - Driver assignÃ©
   - Navigation vers adresse client
   - Scan chaque item/box
   - Photos de chaque item
   - Signature client sur tablette/phone
   - Transport vers entrepÃ´t
   
4. **RÃ©ception entrepÃ´t**
   - Scan items Ã  l'arrivÃ©e
   - Photos supplÃ©mentaires
   - Attribution emplacement warehouse
   - Inventaire complet avec photos
   - Client reÃ§oit gallery photos
   
5. **Stockage**
   - Items tracked par barcode
   - Localisation prÃ©cise dans warehouse
   - Client peut voir inventory online
   
6. **Delivery (sur demande)**
   - Client request delivery d'items spÃ©cifiques
   - SÃ©lection items depuis inventory
   - Choix date/heure delivery
   - Driver picking items
   - Scan out
   - Delivery Ã  l'adresse
   - Signature client
   
7. **Fin de stockage**
   - Client request final delivery (tout)
   - OU vient chercher Ã  l'entrepÃ´t
   - Final billing
   - Close account

### 6.3 Base de donnÃ©es Valet Storage

```sql
-- Table valet_orders
CREATE TABLE valet_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    site_id BIGINT NOT NULL, -- Warehouse
    user_id BIGINT NOT NULL, -- Customer
    uuid UUID UNIQUE NOT NULL,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    
    -- Type
    order_type ENUM('pickup', 'delivery', 'pickup_delivery') DEFAULT 'pickup',
    
    -- Pricing model
    pricing_model ENUM('item_based', 'volume_based', 'flat_rate') DEFAULT 'item_based',
    
    -- Status
    status ENUM(
        'pending',
        'scheduled',
        'driver_assigned',
        'in_transit',
        'at_warehouse',
        'stored',
        'completed',
        'cancelled'
    ) DEFAULT 'pending',
    
    -- Scheduling
    scheduled_date DATE,
    scheduled_time_slot VARCHAR(20), -- '09:00-12:00'
    actual_pickup_time TIMESTAMP NULL,
    actual_delivery_time TIMESTAMP NULL,
    
    -- Address
    address_type ENUM('pickup', 'delivery'),
    address_line1 VARCHAR(255),
    address_line2 VARCHAR(255),
    city VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(2),
    
    -- Location
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- Contact
    contact_name VARCHAR(255),
    contact_phone VARCHAR(50),
    access_instructions TEXT,
    
    -- Driver
    driver_id BIGINT NULL,
    driver_notes TEXT,
    
    -- Items
    estimated_items_count INT DEFAULT 0,
    actual_items_count INT DEFAULT 0,
    estimated_volume DECIMAL(10,2), -- mÂ³
    actual_volume DECIMAL(10,2),
    
    -- Charges
    base_charge DECIMAL(10,2) DEFAULT 0,
    distance_charge DECIMAL(10,2) DEFAULT 0,
    extra_items_charge DECIMAL(10,2) DEFAULT 0,
    total_charge DECIMAL(10,2) DEFAULT 0,
    
    -- Signature
    signature_url VARCHAR(500),
    signed_at TIMESTAMP NULL,
    signed_by VARCHAR(255),
    
    -- Photos
    photos JSON, -- Array d'URLs
    
    -- Metadata
    settings JSON,
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    cancelled_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (site_id) REFERENCES sites(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (driver_id) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_scheduled (scheduled_date, scheduled_time_slot),
    INDEX idx_driver (driver_id)
);

-- Table valet_order_steps (Ã©tapes workflow)
CREATE TABLE valet_order_steps (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    
    step_type ENUM(
        'order_placed',
        'driver_assigned',
        'driver_en_route',
        'arrived',
        'items_collected',
        'in_transit_to_warehouse',
        'arrived_at_warehouse',
        'items_stored',
        'out_for_delivery',
        'delivered',
        'completed'
    ),
    
    status ENUM('pending', 'in_progress', 'completed', 'skipped') DEFAULT 'pending',
    
    scheduled_at TIMESTAMP NULL,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    
    performed_by BIGINT NULL, -- user_id
    location_lat DECIMAL(10, 8),
    location_lng DECIMAL(11, 8),
    
    notes TEXT,
    photos JSON,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES valet_orders(id) ON DELETE CASCADE,
    FOREIGN KEY (performed_by) REFERENCES users(id)
);

-- Table valet_items (inventaire items)
CREATE TABLE valet_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    order_id BIGINT NOT NULL, -- Premier order (pickup)
    user_id BIGINT NOT NULL, -- Owner
    uuid UUID UNIQUE NOT NULL,
    
    -- Identification
    item_number VARCHAR(50) UNIQUE NOT NULL,
    barcode VARCHAR(100) UNIQUE NOT NULL,
    
    -- Description
    item_type VARCHAR(100), -- 'box', 'furniture', 'bike', etc.
    item_name VARCHAR(255),
    description TEXT,
    
    -- Dimensions & Weight
    length DECIMAL(6,2), -- cm
    width DECIMAL(6,2),
    height DECIMAL(6,2),
    volume DECIMAL(10,3), -- mÂ³
    weight DECIMAL(10,2), -- kg
    
    -- Warehouse location
    warehouse_location VARCHAR(100), -- 'A-12-3' (Aisle-Rack-Shelf)
    
    -- Status
    status ENUM(
        'pending_pickup',
        'in_transit',
        'at_warehouse',
        'stored',
        'pending_delivery',
        'out_for_delivery',
        'delivered',
        'lost',
        'damaged'
    ) DEFAULT 'pending_pickup',
    
    -- Dates
    collected_at TIMESTAMP NULL,
    stored_at TIMESTAMP NULL,
    delivered_at TIMESTAMP NULL,
    
    -- Photos
    photos JSON, -- Array d'URLs avec timestamps
    condition_on_pickup TEXT,
    condition_on_delivery TEXT,
    
    -- Valeur dÃ©clarÃ©e (pour assurance)
    declared_value DECIMAL(10,2),
    
    -- Metadata
    settings JSON,
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (order_id) REFERENCES valet_orders(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_barcode (barcode),
    INDEX idx_status (status),
    INDEX idx_user (user_id),
    INDEX idx_warehouse_location (warehouse_location)
);

-- Table valet_item_movements (tracking mouvements)
CREATE TABLE valet_item_movements (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    item_id BIGINT NOT NULL,
    
    movement_type ENUM(
        'scanned_in',
        'scanned_out',
        'moved',
        'inspected',
        'damaged',
        'repaired'
    ),
    
    from_location VARCHAR(100),
    to_location VARCHAR(100),
    
    performed_by BIGINT NOT NULL,
    performed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    notes TEXT,
    photos JSON,
    
    FOREIGN KEY (item_id) REFERENCES valet_items(id) ON DELETE CASCADE,
    FOREIGN KEY (performed_by) REFERENCES users(id),
    INDEX idx_item (item_id),
    INDEX idx_performed_at (performed_at)
);

-- Table valet_pricing_plans
CREATE TABLE valet_pricing_plans (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL,
    
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    pricing_model ENUM('item_based', 'volume_based', 'flat_rate') DEFAULT 'item_based',
    
    -- Item-based pricing
    price_per_item_monthly DECIMAL(10,2),
    
    -- Volume-based pricing
    price_per_cubic_meter_monthly DECIMAL(10,2),
    
    -- Flat rate
    flat_rate_monthly DECIMAL(10,2),
    included_items INT,
    extra_item_price DECIMAL(10,2),
    
    -- Pickup & Delivery fees
    pickup_fee DECIMAL(10,2) DEFAULT 0,
    delivery_fee DECIMAL(10,2) DEFAULT 0,
    distance_fee_per_km DECIMAL(10,2) DEFAULT 0,
    free_distance_km INT DEFAULT 0,
    
    -- Minimums
    minimum_charge DECIMAL(10,2) DEFAULT 0,
    minimum_storage_months INT DEFAULT 1,
    
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- Table driver_schedules (planning drivers)
CREATE TABLE driver_schedules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    driver_id BIGINT NOT NULL,
    
    schedule_date DATE NOT NULL,
    time_slot_start TIME NOT NULL,
    time_slot_end TIME NOT NULL,
    
    capacity INT DEFAULT 10, -- Nombre de collections/deliveries max
    current_bookings INT DEFAULT 0,
    
    is_available BOOLEAN DEFAULT TRUE,
    
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (driver_id) REFERENCES users(id),
    UNIQUE KEY unique_driver_slot (driver_id, schedule_date, time_slot_start)
);
```

### 6.4 Driver Mobile App

#### 6.4.1 FonctionnalitÃ©s

**Dashboard Driver:**
- Assignments d'aujourd'hui
- Map avec tous les stops
- Route optimization
- Status chaque job

**Job Details:**
- Info client (nom, tÃ©lÃ©phone, adresse)
- Instructions accÃ¨s
- Items attendus
- Photos prÃ©cÃ©dentes (si delivery)
- Navigation vers adresse

**Pendant Collection:**
- Scan barcode de chaque item/box
- Take photos de chaque item (minimum 1, recommandÃ© 3-4 angles)
- Ajouter notes condition
- Capture signature client
- Complete job

**Pendant Delivery:**
- Liste items Ã  livrer
- Scan out chaque item
- Photos delivery
- Signature client
- Complete job

**Warehouse Operations:**
- Scan items Ã  l'arrivÃ©e
- Assign warehouse location
- Scan items avant delivery
- Inventory management

#### 6.4.2 API Routes

```php
// Routes Driver API
Route::prefix('driver')->middleware('auth:api', 'role:driver')->group(function() {
    // Dashboard
    Route::get('dashboard', [DriverController::class, 'dashboard']);
    Route::get('today-jobs', [DriverController::class, 'getTodayJobs']);
    
    // Job Management
    Route::get('jobs/{order}', [DriverController::class, 'getJobDetails']);
    Route::post('jobs/{order}/start', [DriverController::class, 'startJob']);
    Route::post('jobs/{order}/arrive', [DriverController::class, 'markArrived']);
    Route::post('jobs/{order}/complete', [DriverController::class, 'completeJob']);
    
    // Item Scanning
    Route::post('items/scan', [DriverController::class, 'scanItem']);
    Route::post('items/{item}/photo', [DriverController::class, 'uploadItemPhoto']);
    Route::post('items/{item}/update-location', [DriverController::class, 'updateItemLocation']);
    
    // Signature
    Route::post('jobs/{order}/signature', [DriverController::class, 'captureSignature']);
    
    // Notes & Issues
    Route::post('jobs/{order}/notes', [DriverController::class, 'addNotes']);
    Route::post('items/{item}/issue', [DriverController::class, 'reportIssue']);
    
    // Navigation
    Route::get('jobs/{order}/navigation', [DriverController::class, 'getNavigation']);
    
    // Schedule
    Route::get('schedule', [DriverController::class, 'getSchedule']);
    Route::post('schedule/availability', [DriverController::class, 'setAvailability']);
});
```

---

**[Ã€ SUIVRE DANS LA PARTIE 2 DU DOCUMENT...]**

Ce document continue avec:
- Module Facturation & Paiements (dÃ©tails complets)
- SystÃ¨me d'Analytics & Reporting
- IntÃ©grations (Stripe, Access Control, Accounting, etc.)
- SÃ©curitÃ© & ConformitÃ© RGPD
- API & Webhooks documentation complÃ¨te
- Architecture base de donnÃ©es complÃ¨te avec indexes
- SpÃ©cifications techniques dÃ©taillÃ©es (caching, queues, notifications, emails)
- Plan de dÃ©ploiement et scalabilitÃ©

Le document fait actuellement environ 25 000 mots. Voulez-vous que je continue avec la Partie 2 ?
